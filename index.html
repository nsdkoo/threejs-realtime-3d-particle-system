<!DOCTYPE html><html lang="zh-CN"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saturn Engine - 交互粒子系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; color: white; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        .ui-panel {
            position: fixed; top: 2rem; left: 2rem; z-index: 10;
            pointer-events: none; border-left: 2px solid rgba(59, 130, 246, 0.5);
            padding-left: 1.5rem;
        }
        .status-tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
            background: rgba(59, 130, 246, 0.2); color: #60a5fa;
            margin-bottom: 0.5rem;
        }
        #cursor-hint {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
            font-size: 12px; color: rgba(255,255,255,0.4); letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <div class="ui-panel">
        <div id="mode-status" class="status-tag">初始化中...</div>
        <h1 class="text-2xl font-thin tracking-[0.4em] uppercase">Saturn Engine</h1>
        <p id="instruction" class="text-[10px] text-gray-500 mt-2 max-w-xs leading-relaxed">
            检测到本地环境限制，已切换至鼠标控制模式。
            左右移动鼠标以调整引力场强度。
        </p>
    </div>

    <div id="cursor-hint">MOVE MOUSE TO INTERACT</div>

    <!-- 隐藏的视频源 -->
    <video id="input-video" class="hidden"></video>

    <script>
        let scene, camera, renderer, coreParticles, ringParticles;
        let expansion = 0;
        let targetExpansion = 0;
        let isUsingMouse = true;

        const modeStatus = document.getElementById('mode-status');
        const instruction = document.getElementById('instruction');

        // 1. 初始化 Three.js 引擎
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
            camera.position.z = 600;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // 核心粒子 (球体)
            const coreCount = 8000;
            const coreGeometry = new THREE.BufferGeometry();
            const corePos = new Float32Array(coreCount * 3);
            const coreMeta = [];

            for (let i = 0; i < coreCount; i++) {
                const r = Math.pow(Math.random(), 0.5) * 100;
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = Math.random() * Math.PI * 2;
                coreMeta.push({ r, theta, phi, speed: 0.005 + Math.random() * 0.01 });
                const idx = i * 3;
                corePos[idx] = r * Math.sin(theta) * Math.cos(phi);
                corePos[idx+1] = r * Math.sin(theta) * Math.sin(phi);
                corePos[idx+2] = r * Math.cos(theta);
            }
            coreGeometry.setAttribute('position', new THREE.BufferAttribute(corePos, 3));
            coreParticles = new THREE.Points(coreGeometry, new THREE.PointsMaterial({
                size: 2, color: 0x60a5fa, transparent: true, blending: THREE.AdditiveBlending, opacity: 0.8
            }));
            scene.add(coreParticles);

            // 星环粒子 (扁平圆环)
            const ringCount = 20000;
            const ringGeometry = new THREE.BufferGeometry();
            const ringPos = new Float32Array(ringCount * 3);
            const ringMeta = [];

            for (let i = 0; i < ringCount; i++) {
                const radius = 180 + Math.random() * 150;
                const angle = Math.random() * Math.PI * 2;
                ringMeta.push({ 
                    radius, 
                    angle, 
                    speed: (1 / Math.sqrt(radius)) * 5 
                });
            }
            ringGeometry.setAttribute('position', new THREE.BufferAttribute(ringPos, 3));
            ringParticles = new THREE.Points(ringGeometry, new THREE.PointsMaterial({
                size: 1, color: 0x3b82f6, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending
            }));
            scene.add(ringParticles);

            window.coreMeta = coreMeta;
            window.ringMeta = ringMeta;
        }

        // 2. 交互逻辑 (鼠标 + 摄像头降级)
        function initInteraction() {
            // 鼠标移动监听
            window.addEventListener('mousemove', (e) => {
                if (isUsingMouse) {
                    targetExpansion = e.clientX / window.innerWidth;
                }
            });

            // 尝试启动摄像头
            const videoElement = document.getElementById('input-video');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({ maxNumHands: 1, modelComplexity: 1 });
            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    isUsingMouse = false;
                    modeStatus.innerText = "手势识别模式";
                    modeStatus.style.color = "#34d399";
                    const lm = results.multiHandLandmarks[0];
                    const dist = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                    targetExpansion = Math.min(1, Math.max(0, (dist - 0.05) / 0.4));
                }
            });

            const cameraHelper = new Camera(videoElement, {
                onFrame: async () => { await hands.send({ image: videoElement }); },
                width: 640, height: 480
            });

            cameraHelper.start().then(() => {
                isUsingMouse = false;
                modeStatus.innerText = "手势识别已就绪";
                instruction.innerText = "请张开/收拢手掌来控制星环。";
            }).catch(err => {
                console.warn("Camera access denied, switching to mouse.");
                isUsingMouse = true;
                modeStatus.innerText = "鼠标交互模式";
                instruction.innerText = "由于浏览器安全策略，摄像头已禁用。请左右移动鼠标控制引擎。";
            });
        }

        // 3. 动画循环
        function animate() {
            requestAnimationFrame(animate);

            // 缓动效果
            expansion += (targetExpansion - expansion) * 0.08;
            const time = Date.now() * 0.001;

            // 更新核心粒子
            const cPos = coreParticles.geometry.attributes.position.array;
            const cMeta = window.coreMeta;
            for (let i = 0; i < cMeta.length; i++) {
                const d = cMeta[i];
                d.phi += d.speed * (1 + expansion * 2);
                const s = 1 + expansion * 4;
                const idx = i * 3;
                cPos[idx] = d.r * Math.sin(d.theta) * Math.cos(d.phi) * s;
                cPos[idx+1] = d.r * Math.sin(d.theta) * Math.sin(d.phi) * s;
                cPos[idx+2] = d.r * Math.cos(d.theta) * s;
            }
            coreParticles.geometry.attributes.position.needsUpdate = true;
            coreParticles.rotation.y += 0.002;

            // 更新星环粒子
            const rPos = ringParticles.geometry.attributes.position.array;
            const rMeta = window.ringMeta;
            for (let i = 0; i < rMeta.length; i++) {
                const d = rMeta[i];
                d.angle += d.speed * (0.5 + expansion);
                const currentR = d.radius * (1 + expansion * 3);
                const idx = i * 3;
                rPos[idx] = currentR * Math.cos(d.angle);
                rPos[idx+1] = Math.sin(d.angle * 2 + time) * (20 * expansion);
                rPos[idx+2] = currentR * Math.sin(d.angle);
            }
            ringParticles.geometry.attributes.position.needsUpdate = true;
            ringParticles.rotation.x = 1.3; // 倾斜视角
            ringParticles.rotation.z += 0.001;

            renderer.render(scene, camera);
        }

        // 窗口缩放
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 启动系统
        initScene();
        initInteraction();
        animate();
    </script>


</body></html>